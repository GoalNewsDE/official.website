<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GoalNews â€“ Moderner Benutzer Dashboard</title>

<!-- Poppins -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#f4f7f9;
  --card:#ffffff;
  --accent:#1db954;
  --accent-dark:#169b48;
  --gold:#ffd700;
  --muted:#9aa6b2;
  --glass: rgba(255,255,255,0.6);
  --shadow: 0 8px 24px rgba(16,24,40,0.08);
  --radius: 12px;
}

*{box-sizing:border-box;font-family:"Poppins",sans-serif}
html,body{height:100%;margin:0;background:var(--bg);color:#122;}
.app { display:flex; gap:24px; padding:28px; max-width:1200px; margin:18px auto; }
.sidebar { width:90px; min-width:90px; background:linear-gradient(180deg,#fff,#f7fbf7); border-radius:14px; padding:12px; box-shadow:var(--shadow); display:flex; flex-direction:column; align-items:center; gap:12px; }
.logoSmall{font-size:22px}
.iconBtn{ width:56px;height:56px;border-radius:10px;background:var(--card); display:flex;align-items:center;justify-content:center;cursor:pointer; box-shadow:0 6px 18px rgba(16,24,40,0.06);transition:transform .14s; position:relative;}
.iconBtn:hover{transform:translateY(-4px)}
.iconBtn .badge{ position:absolute;margin-top:-30px;margin-left:18px;background:#ff3b30;color:white;border-radius:8px;padding:2px 6px;font-size:12px;}
.main { flex:1; display:flex;flex-direction:column;gap:18px; }
.topbar { display:flex;align-items:center;justify-content:space-between;gap:16px; }
.profileHeader{ display:flex;align-items:center;gap:16px; background:linear-gradient(90deg, rgba(255,255,255,0.9), rgba(255,255,255,0.95)); padding:14px;border-radius:14px;box-shadow:var(--shadow); }
.avatar{ width:72px;height:72px;border-radius:18px;background:linear-gradient(135deg,var(--accent),var(--accent-dark)); display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:20px;box-shadow:0 8px 18px rgba(29,185,84,0.18); overflow:hidden; }
.avatar img{ width:100%; height:100%; object-fit:cover; border-radius:18px; }
.profileInfo h3{margin:0;font-size:18px}
.profileInfo p{margin:2px 0 0 0;color:var(--muted);font-size:13px}
.grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:18px; }
.card{ background:var(--card); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow); transition:transform .12s, box-shadow .12s; }
.card:hover{transform:translateY(-6px)}
.card.h2{display:flex;align-items:center;justify-content:space-between}
.card .title{font-weight:600;color:#122}
.small{font-size:13px;color:var(--muted)}
.coinsBig{display:flex;align-items:center;gap:12px}
.coinBadge{ width:68px;height:68px;border-radius:14px;background:linear-gradient(135deg,var(--gold), #ffd24d); display:flex;align-items:center;justify-content:center;font-weight:800;color:#4b3b00;font-size:20px; box-shadow:0 8px 22px rgba(255,203,54,0.2); }
.row{display:flex;gap:10px;align-items:center}
.btn{ background:var(--accent);color:white;padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:600; }
.btn.ghost{background:transparent;border:1px solid #e6eef0;color:#122}
.btn.warn{background:#ff6b6b}
.input{ width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef0;background:#fbfeff; }
.messages{max-height:160px;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:8px}
.msg{padding:8px 10px;border-radius:10px;background:#f3fbf5;color:#0b3a19;align-self:flex-start;max-width:70%}
.msg.admin{background:#eef2f8;color:#08233a;align-self:flex-end}
.adminPanel{display:flex;gap:12px;flex-wrap:wrap}
.user-card { background:#fffef6;border-left:4px solid var(--gold);padding:10px;border-radius:10px;cursor:pointer;min-width:170px; }
.footer{ text-align:center;color:var(--muted);font-size:13px;padding:12px; margin-top:10px; }
@media(max-width:940px){ .grid{grid-template-columns:repeat(2,1fr)} .sidebar{display:none} }
@media(max-width:600px){ .grid{grid-template-columns:1fr} .profileHeader{flex-direction:column;align-items:flex-start} }
.spin { animation: spin .6s linear; }
@keyframes spin { 0%{transform:rotate(0)}100%{transform:rotate(360deg)} }
.levelBar{height:10px;background:#eef6f0;border-radius:8px;overflow:hidden}
.levelBar > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-dark));width:40%}
.badges{display:flex;gap:6px;flex-wrap:wrap}
.badge{ background:linear-gradient(180deg,#fff8e0,#fff0b3);padding:6px 8px;border-radius:10px;font-weight:700;color:#4b3b00;font-size:12px; }
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="logoSmall">GN</div>
    <div id="homeBtn" class="iconBtn" title="Home">ğŸ </div>
    <div id="liveBtn" class="iconBtn" title="Live">âš¡</div>
    <div id="spinBtn" class="iconBtn" title="Daily Spin">ğŸ¡</div>
    <div id="notifBtn" class="iconBtn" title="Benachrichtigungen">ğŸ”” <span id="notifBadge" class="badge" style="display:none">0</span></div>
    <div id="profileBtn" class="iconBtn" title="Profil">ğŸ‘¤</div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="profileHeader card" style="flex:1">
        <div class="avatar" id="avatar">U</div>
        <div class="profileInfo">
          <h3 id="username">User</h3>
          <p id="subtitle" class="small">Willkommen zurÃ¼ck!</p>
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <div class="coinBadge" id="coinBadge">0</div>
            <div style="min-width:140px">
              <div class="small">Level <span id="userLevel">1</span> â€¢ XP <span id="userXP">0</span></div>
              <div class="levelBar" style="margin-top:6px"><i id="levelFill" style="width:10%"></i></div>
            </div>
          </div>
        </div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <button id="logoutBtn" class="btn ghost">Logout</button>
        </div>
      </div>
    </div>

    <section class="grid">
      <!-- Coins card -->
      <div class="card">
        <div class="h2">
          <div><div class="title">ğŸ’° Coins</div><div class="small">Dein Kontostand</div></div>
          <div style="text-align:right">
            <div style="font-size:13px;color:var(--muted)">ID: <span id="userIdShort">â€”</span></div>
          </div>
        </div>
        <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
          <div class="coinsBig">
            <div class="coinBadge" id="coinsDisplay">0</div>
            <div>
              <div style="font-weight:700;font-size:18px" id="coinsText">0 Coins</div>
              <div class="small">Sammle Coins & tausche sie ein</div>
            </div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button id="openDailySpin" class="btn">Daily Spin</button>
            <button id="buyBreakingBtn" class="btn">ğŸ”¥ Breaking News (3000)</button>
          </div>
        </div>
      </div>

      <!-- Lieblingsverein card -->
      <div class="card">
        <div class="title">âš½ Lieblingsverein</div>
        <div class="small">Zeige deinen Verein & erhalte Updates</div>
        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <input id="favTeamInput" class="input" placeholder="z. B. Bayern MÃ¼nchen">
          <button id="saveTeamBtn" class="btn">Speichern</button>
        </div>
        <div style="margin-top:8px" class="small">Dein Team: <b id="favTeamLabel">â€”</b></div>
      </div>

      <!-- Messages -->
      <div class="card">
        <div class="h2"><div><div class="title">âœ‰ï¸ Nachrichten</div><div class="small">PersÃ¶nliche Mitteilungen</div></div></div>
        <div class="messages" id="personalMsg">Noch keine Nachricht erhalten.</div>
      </div>

      <!-- Breaking News -->
      <div class="card">
        <div class="title">ğŸ”¥ Breaking News Leiste</div>
        <div class="small">Einmalige Aktivierung fÃ¼r 3000 Coins</div>
        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <div id="breakingStatus" class="small">Status: <b>Deaktiviert</b></div>
          <div style="margin-left:auto">
            <button id="openBreakingBtn" class="btn ghost">Ã–ffnen</button>
          </div>
        </div>
      </div>

      <!-- Admin card -->
      <div class="card" id="adminCard" style="display:none">
        <div class="title">ğŸ”’ Admin Panel</div>
        <div class="small">Benutzer verwalten & Nachrichten senden</div>
        <div style="margin-top:10px">
          <div id="usersList" class="adminPanel"></div>
          <div style="margin-top:8px">
            <div class="small">Aktion auf ausgewÃ¤hlten Benutzer:</div>
            <input id="adminMsgInput" class="input" placeholder="Nachricht an Benutzer">
            <button id="sendAdminMsgBtn" class="btn">Nachricht senden</button>
            <div style="display:flex;gap:8px;margin-top:8px">
              <input id="addCoinsInput" type="number" class="input" placeholder="Coins">
              <button id="addCoinsBtn" class="btn">+ Coins</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Badges & Level -->
      <div class="card">
        <div class="title">ğŸ… Badges & Level</div>
        <div class="small">Sammle XP & schalte Badges frei</div>
        <div style="margin-top:12px" class="badges" id="badgesContainer"></div>
        <div style="margin-top:12px" class="small">
          NÃ¤chster Level in <span id="xpToNext">100</span> XP
        </div>
      </div>

      <!-- Live games quick-link -->
      <div class="card">
        <div class="title">âš¡ Live Ticker</div>
        <div class="small">Alle Spiele & Minuten auf einen Blick</div>
        <div style="margin-top:12px">
          <a href="index.html" class="btn ghost">Zum Live Ticker</a>
          <a href="football.html" class="btn" style="margin-left:6px">Football</a>
        </div>
      </div>

      <!-- Profile settings & footer -->
      <div class="card" style="grid-column:span 3">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div>
            <div style="font-weight:800">Einstellungen & Profil</div>
            <div class="small">Ã„ndere Username & Profilbild</div>
          </div>
          <div style="display:flex;gap:8px">
            <button id="changeNameBtn" class="btn ghost">Username Ã¤ndern</button>
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:12px;align-items:center">
          <input id="changeNameInput" class="input" placeholder="Neuer Username">
          <input id="avatarInput" type="file" accept=".jpg,.jpeg,.png" class="input" style="max-width:180px">
          <button id="saveProfileBtn" class="btn">Speichern</button>
        </div>
      </div>
    </section>

    <div class="footer card">Â© 2025 GoalNews Â· Sound by Pixabay Â· Merry Christmas ğŸ„</div>
  </main>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, onSnapshot, collection, getDocs, arrayUnion, addDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-storage.js";

// Firebase Config
const firebaseConfig = { 
  apiKey: "AIzaSyBmIcdFtxv4jBJKdiAkEiwnkQ8yRwiG_0w",
  authDomain: "goalnewsde-community.firebaseapp.com",
  projectId: "goalnewsde-community",
  storageBucket: "goalnewsde-community.appspot.com",
  messagingSenderId: "134523022055",
  appId: "1:134523022055:web:4f35ed7812d06e4fb55042"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);
setPersistence(auth, browserLocalPersistence);

const ADMIN_UIDS = ["gaPuzG1ULdUSskKUsciL1g79nh72"];

// UI Elements
const usernameEl = document.getElementById("username");
const avatarEl = document.getElementById("avatar");
const coinBadge = document.getElementById("coinsDisplay");
const coinsText = document.getElementById("coinsText");
const coinBadgeSmall = document.getElementById("coinBadge");
const userIdShortEl = document.getElementById("userIdShort");
const favTeamInput = document.getElementById("favTeamInput");
const favTeamLabel = document.getElementById("favTeamLabel");
const saveTeamBtn = document.getElementById("saveTeamBtn");
const personalMsg = document.getElementById("personalMsg");
const buyBreakingBtn = document.getElementById("buyBreakingBtn");
const breakingStatus = document.getElementById("breakingStatus");
const openDailySpin = document.getElementById("openDailySpin");
const usersList = document.getElementById("usersList");
const adminCard = document.getElementById("adminCard");
const addCoinsBtn = document.getElementById("addCoinsBtn");
const addCoinsInput = document.getElementById("addCoinsInput");
const adminMsgInput = document.getElementById("adminMsgInput");
const sendAdminMsgBtn = document.getElementById("sendAdminMsgBtn");
const changeNameInput = document.getElementById("changeNameInput");
const changeNameBtn = document.getElementById("changeNameBtn");
const saveProfileBtn = document.getElementById("saveProfileBtn");
const avatarInput = document.getElementById("avatarInput");
const badgesContainer = document.getElementById("badgesContainer");
const userLevelEl = document.getElementById("userLevel");
const userXPEl = document.getElementById("userXP");
const levelFillEl = document.getElementById("levelFill");
const xpToNextEl = document.getElementById("xpToNext");
const logoutBtn = document.getElementById("logoutBtn");
const notifBadge = document.getElementById("notifBadge");

let currentUserUID = null;
let currentUserData = null;

// Auth Listener
onAuthStateChanged(auth, async user=>{
  if(user){
    currentUserUID = user.uid;
    const userDoc = await getDoc(doc(db,"users",user.uid));
    currentUserData = userDoc.exists() ? userDoc.data() : {};
    renderUser();
    if(ADMIN_UIDS.includes(user.uid)){
      adminCard.style.display="block";
      loadUsers();
    }
    loadMessages();
  }else{
    location.href="login.html";
  }
});

// Render User Profile
function renderUser(){
  usernameEl.textContent = currentUserData.username || "User";
  userIdShortEl.textContent = currentUserUID?.slice(0,6) || "â€”";
  coinBadge.textContent = currentUserData.coins || 0;
  coinsText.textContent = (currentUserData.coins||0) + " Coins";
  coinBadgeSmall.textContent = currentUserData.coins||0;
  favTeamLabel.textContent = currentUserData.favTeam||"â€”";
  userLevelEl.textContent = currentUserData.level||1;
  userXPEl.textContent = currentUserData.xp||0;
  levelFillEl.style.width = ((currentUserData.xp||0)/100*100) + "%";
  xpToNextEl.textContent = 100 - (currentUserData.xp||0);
  if(currentUserData.avatarUrl){
    avatarEl.innerHTML = `<img src="${currentUserData.avatarUrl}" />`;
  }else{
    avatarEl.textContent = (currentUserData.username||"U")[0].toUpperCase();
  }
}

// Logout
logoutBtn.addEventListener("click",()=>signOut(auth));

// Save Favorite Team
saveTeamBtn.addEventListener("click",async ()=>{
  await updateDoc(doc(db,"users",currentUserUID),{favTeam:favTeamInput.value});
  currentUserData.favTeam = favTeamInput.value;
  renderUser();
});

// Load Admin Users
async function loadUsers(){
  const usersSnapshot = await getDocs(collection(db,"users"));
  usersList.innerHTML = "";
  usersSnapshot.forEach(docSnap=>{
    const data = docSnap.data();
    const div = document.createElement("div");
    div.className="user-card";
    div.textContent = data.username || "User";
    div.dataset.uid = docSnap.id;
    div.addEventListener("click",()=>{ div.classList.toggle("selected"); });
    usersList.appendChild(div);
  });
}

// Send Admin Message
sendAdminMsgBtn.addEventListener("click", async ()=>{
  const msg = adminMsgInput.value.trim();
  if(!msg) return;
  const selectedUsers = Array.from(usersList.querySelectorAll(".selected")).map(el=>el.dataset.uid);
  for(const uid of selectedUsers){
    await updateDoc(doc(db,"users",uid), { messages: arrayUnion({ text: msg, from:"admin", timestamp: Date.now() }) });
  }
  adminMsgInput.value="";
});

// Add Coins
addCoinsBtn.addEventListener("click", async ()=>{
  const coins = parseInt(addCoinsInput.value)||0;
  const selectedUsers = Array.from(usersList.querySelectorAll(".selected")).map(el=>el.dataset.uid);
  for(const uid of selectedUsers){
    const userRef = doc(db,"users",uid);
    const userSnap = await getDoc(userRef);
    const data = userSnap.data() || {};
    await updateDoc(userRef,{coins:(data.coins||0)+coins});
  }
  addCoinsInput.value="";
});

// Change Username
changeNameBtn.addEventListener("click", async ()=>{
  const newName = changeNameInput.value.trim();
  if(newName){
    await updateDoc(doc(db,"users",currentUserUID),{username:newName});
    currentUserData.username = newName;
    renderUser();
    changeNameInput.value="";
  }
});

// Save Profile (Avatar)
saveProfileBtn.addEventListener("click", async ()=>{
  if(avatarInput.files.length){
    const file = avatarInput.files[0];
    if(!["image/png","image/jpeg"].includes(file.type)){
      alert("Nur PNG/JPG erlaubt!");
      return;
    }
    const storageRef = ref(storage, `avatars/${currentUserUID}_${file.name}`);
    await uploadBytes(storageRef, file);
    const url = await getDownloadURL(storageRef);
    await updateDoc(doc(db,"users",currentUserUID),{avatarUrl:url});
    currentUserData.avatarUrl = url;
    renderUser();
  }
});

// Load Messages
function loadMessages(){
  const userRef = doc(db,"users",currentUserUID);
  onSnapshot(userRef,msgSnap=>{
    const data = msgSnap.data();
    personalMsg.innerHTML="";
    if(data?.messages?.length){
      data.messages.forEach(m=>{
        const div = document.createElement("div");
        div.className = "msg " + (m.from==="admin"?"admin":"");
        div.textContent = m.text;
        personalMsg.appendChild(div);
      });
    }else{
      personalMsg.textContent="Noch keine Nachricht erhalten.";
    }
  });
}
</script>
</body>
</html>
